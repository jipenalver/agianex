# Supabase Reports Integration

## Overview

The FAB (Floating Action Button) camera and image browsing functionality has been integrated with Supabase to automatically create citizen reports in the database.

## Database Schema

The integration uses the `reports` table with the following structure:

```sql
create table public.reports (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  user_id uuid null,
  latitude text null,
  longitude text null,
  image_path text null,
  report_type text null,
  description text null,
  location text null,
  priority text null,
  status text null,
  constraint reports_pkey primary key (id),
  constraint reports_user_id_fkey foreign KEY (user_id) references auth.users (id)
);
```

## Functionality

### Camera Capture (üé• Button)

1. **Takes Photo**: Uses Capacitor Camera API
2. **Gets Location**: Automatically captures GPS coordinates using `useGeolocation`
3. **Creates Report**: Inserts new record in `reports` table
4. **Uploads Image**: Stores image in Supabase Storage (`agianex` bucket)
5. **Updates Record**: Links image URL to the report record

### Image Browser (üñºÔ∏è Button)

1. **Selects Images**: Opens file picker (web) or gallery (native)
2. **Gets Location**: Automatically captures GPS coordinates
3. **Creates Reports**: Creates separate report for each selected image
4. **Uploads Images**: Stores images in Supabase Storage
5. **Updates Records**: Links image URLs to report records

## Data Flow

### 1. Report Creation

```typescript
const { data: reportData, error: reportError } = await supabase
  .from('reports')
  .insert({
    user_id: authUserData.userData?.id,
    latitude: coords.value.latitude.toString(),
    longitude: coords.value.longitude.toString(),
    status: 'Pending',
  })
  .select()
  .single()
```

### 2. Image Upload

```typescript
const reportImagePath = `reports/${reportData.id}-${fileName}`
const { data: uploadData, error: uploadError } = await supabase.storage
  .from('agianex')
  .upload(reportImagePath, imageFile, {
    cacheControl: '3600',
    upsert: true,
  })
```

### 3. Update Report with Image URL

```typescript
const { data: imageData } = supabase.storage.from('agianex').getPublicUrl(uploadData.path)

const { error: updateError } = await supabase
  .from('reports')
  .update({
    image_path: imageData.publicUrl,
  })
  .eq('id', reportData.id)
```

## File Structure

### Storage Organization

- **Bucket**: `agianex`
- **Path**: `reports/{report_id}-{filename}`
- **Example**: `reports/123-photo_1640995200000.jpg`

### Filename Convention

- **Camera**: `photo_{timestamp}.jpg`
- **Browser**: `selected_{timestamp}_{index}.{extension}`

## Features Implemented

### ‚úÖ Automatic Data Collection

- **User ID**: From authenticated user session
- **GPS Coordinates**: Real-time geolocation
- **Timestamp**: Automatic creation time
- **Image**: High-quality photo upload

### ‚úÖ Error Handling

- **Database Errors**: Clear error messages
- **Upload Failures**: Retry capability
- **Location Access**: Graceful fallback
- **User Feedback**: Success/error notifications

### ‚úÖ Cross-Platform Support

- **Web**: File picker with multiple selection
- **Android**: Native camera and gallery integration
- **Consistent**: Same data structure across platforms

### ‚úÖ Security

- **Authentication**: User must be logged in
- **Authorization**: User ID automatically linked
- **Storage**: Secure Supabase Storage with public URLs
- **Validation**: Proper error handling and validation

## User Experience

### Workflow

1. User clicks FAB button
2. Chooses camera or gallery option
3. Takes photo or selects images
4. App automatically:
   - Gets current location
   - Creates report record
   - Uploads image
   - Links image to report
   - Shows success message

### Feedback

- **Success**: "Report #123 submitted successfully!"
- **Location**: GPS coordinates captured automatically
- **Upload**: Image stored securely in cloud
- **Database**: Report created with all metadata

## Integration Points

### Authentication Store

```typescript
import { useAuthUserStore } from '@/stores/authUser'
const authUserData = useAuthUserStore()
// Access: authUserData.userData?.id
```

### Geolocation

```typescript
import { useGeolocation } from '@vueuse/core'
const { coords } = useGeolocation({
  enableHighAccuracy: true,
  timeout: 10000,
  maximumAge: 0,
})
```

### Supabase Client

```typescript
import { supabase } from '@/utils/supabase'
// Database operations and storage uploads
```

## Future Enhancements

- Add report type, description, and priority fields
- Implement offline functionality with sync
- Add image compression for better performance
- Include location name resolution (reverse geocoding)
- Add report status updates and admin workflows

The system now provides a complete citizen reporting solution with automatic data collection, cloud storage, and database integration.
